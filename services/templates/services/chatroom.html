{% extends "services/base.html" %} {% block title %}Chat Room{% endblock %} {%
block content %}
<h1>Chat Room</h1>
<div id="chat-messages">
  {% for message in messages %}
  <div class="message">
    <strong>{{ message.user.username }}</strong>: {{ message.message }}
    <small>{{ message.timestamp }}</small>
  </div>
  {% endfor %}
</div>

<form id="chat-form">
  {% csrf_token %}
  <input
    type="text"
    id="message-input"
    placeholder="Type your message here..."
  />
  <button type="submit">Send</button>
</form>

<script>
  const chatSocket = new WebSocket(
    "ws://" + window.location.host + "/ws/chat/"
  );

  chatSocket.onmessage = function (e) {
    const data = JSON.parse(e.data);
    const messageElement = document.createElement("div");
    messageElement.className = "message";
    messageElement.innerHTML = `
            <strong>${data.username}</strong>: ${data.message}
            <small>${new Date(data.timestamp).toLocaleString()}</small>
        `;
    document.querySelector("#chat-messages").prepend(messageElement);
  };

  document.querySelector("#chat-form").onsubmit = function (e) {
    e.preventDefault();
    const messageInput = document.querySelector("#message-input");
    const message = messageInput.value;
    chatSocket.send(
      JSON.stringify({
        message: message,
      })
    );
    messageInput.value = "";
  };
</script>
{% endblock %}
